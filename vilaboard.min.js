!function(){var i=function(e){return document.getElementById(e)};const t=new URLSearchParams(window.location.search);var o,n=!1,r=this.__canvas=new fabric.Canvas("c",{selectedTool:0,isDrawingMode:!0,isPanning:!1,isFullScreen:!1,selectedFill:"#"+t.get("f")||"#000000",selectedStrokeColor:"#"+t.get("f")||"#000000",selectedStroke:2,selectedFont:"sans-serif",undo:[],redo:[],teachingmode:!0,bg:null,clipboard:null,backgroundVpt:!1,pointer:"crosshair",files:[],grid:{padding:0,opacity:50,space:5}});function c(e){fabric.Image.fromURL(e,function(e){r.bg=e,r.bg&&r.setBackgroundImage(r.bg,r.renderAll.bind(r),{scaleX:r.width/r.bg.width,scaleY:r.height/r.bg.height,backgroundImageStretch:!0})})}function l(){r.isDrawingMode=!1;let e=new fabric.Textbox("",{fill:r.selectedFill,fontFamily:r.selectedFont,top:r.height/2-50,left:r.width/2-50,width:100,isEditing:!0,shadow:null});r.teachingmode&&e.setControlsVisibility({bl:!1,tl:!1,tr:!1,ml:!1,mb:!1,mt:!1,mtr:!1}),r.add(e),r.setActiveObject(e),e.exitEditing(),e.enterEditing()}function a(e,t,o){const n=r.getActiveObject();console.log(t,o),n&&console.log(n,n.type),"svg"===t&&(console.log(e.innerHTML),fabric.loadSVGFromString(e.innerHTML,e=>{svg=fabric.util.groupSVGElements(e),svg.top=r.height/2,svg.left=r.width/2,r.add(svg.scale(5)),r.setActiveObject(svg),r.requestRenderAll(),r.isDrawingMode=!1})),null!=t&&null!=o&&("opacity"===t&&(console.log(o),n&&n.set("opacity",o),i("swo").value=o),"fill"===t&&(r.selectedFill=o,n&&n.set("fill",r.selectedFill),r.freeDrawingBrush.color=r.selectedFill),"stroke"===t&&(r.selectedStrokeColor=o,n&&n.set("stroke",r.selectedStrokeColor),r.freeDrawingBrush.color=r.selectedStrokeColor),"strokeWidth"===t&&(e=parseFloat(o,10),Math.exp(-1*Math.pow(e-16.32751,2)/38.3047035912),r.selectedStroke=Math.pow(e,1.0001),n&&(console.log(typeof n),n.set("strokeWidth",r.selectedStroke)),r.freeDrawingBrush.width=r.selectedStroke+1,console.log(o,r.selectedStroke),i("swi").value=o),"fontFamily"===t&&(r.selectedFont=o,n?n.set("fontFamily",r.selectedFont):l()),r.renderAll())}r.setZoom(1),r.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight}),r.setBackgroundColor("#ffffff"),t.get("pattern")&&r.setBackgroundColor({source:"/imgs/"+t.get("pattern"),repeat:"repeat"},function(){r.renderAll()}),t.get("back")&&c("/imgs/"+t.get("back")),fabric.util.loadImage("/imgs/grid-1.png",function(e){e=new fabric.Pattern({source:e,repeate:"repeate"}),new fabric.Rect({fill:e,width:r.width-10,height:r.height-10,left:10,top:10,selectable:!1,dirty:!0,evented:!1,hasBorders:!1,hasControls:!1,objectCaching:!1,shadow:null})}),document.addEventListener("keydown",function(e){const t=r.getActiveObject();if(!(t&&"isEditing"in t&&t.isEditing)){var o=e.key;if("Delete"===o){const n=r.getActiveObjects();n.forEach(e=>{r.remove(e)}),r.requestRenderAll()}if(e.ctrlKey&&"g"===o){if(e.preventDefault(),!t)return;if("activeSelection"!==t.type)return;t.toGroup()}if(e.ctrlKey&&"z"===o){e.preventDefault();const i=r.undo.pop();void 0!==i&&i.undo()}e.ctrlKey&&"c"===o&&(e.preventDefault(),t.clone(function(e){r.clipboard=e})),e.ctrlKey&&"x"===o&&(e.preventDefault(),t.clone(function(e){r.clipboard=e}),r.remove(t)),e.ctrlKey&&"v"===o&&(e.preventDefault(),null!==r.clipboard&&(r.clipboard.top+=10,r.clipboard.left+=10,r.clipboard.clone(function(e){r.add(e),r.setActiveObject(e),r.requestRenderAll(),r.isDrawingMode=!1})))}}),window.addEventListener("resize",function(){console.log(window.innerWidth,window.innerHeight),r.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight}),r.backgroundImage&&(r.backgroundImage.scaleX=r.width/r.backgroundImage.width,r.backgroundImage.scaleY=r.height/r.backgroundImage.height),r.requestRenderAll()}),document.addEventListener("wheel",e=>{e.preventDefault();var t=r.getZoom();e.deltaY<0&&t<10&&r.setZoom(1.1*t),0<e.deltaY&&.3<t&&r.setZoom(.9*t),r.requestRenderAll()}),r.on("mouse:up",function(e){n=!1,r.selection=!0}),r.on("mouse:down",function(e){n=r.isPanning}),r.on("mouse:move",function(e){n&&e&&e.e&&(r.selection=!1,e=new fabric.Point(e.e.movementX,e.e.movementY),r.relativePan(e))}),fabric.Object.prototype.transparentCorners=!1,fabric.Object.prototype.borderColor="#cccccc55",fabric.Object.prototype.cornerColor="#cfcfffee",fabric.Object.prototype.cornerSize=7,fabric.Object.prototype.cornerStyle="circle",i("upl").onchange=o=>{if(0<o.target.files.length)for(let t=0;t<o.target.files.length;t++){let e=new FileReader;e.onload=e=>{url=e.target.result;new fabric.Image.fromURL(url,e=>{e.top=r.height/2,e.left=r.width/2;var t=r.width*e.width/(e.height*e.width);e.scaleX=1/t,e.scaleY=1/t,r.add(e),r.setActiveObject(e),r.isDrawingMode=!1})},e.readAsDataURL(o.target.files[t])}},i("upf").onchange=t=>{if(0<t.target.files.length){let e=new FileReader;e.onload=e=>{url=e.target.result,c(url)},e.readAsDataURL(t.target.files[0])}},i("txt").onclick=l,i("exp").onclick=function(){this.href=r.toDataURL({format:"png",quality:.8,width:r.width,height:r.height}),this.download=(new Date).getTime()+".png"},i("select").onclick=function(){r.isDrawingMode=!1,r.isPanning=!1},i("draw").onclick=function(){r.isDrawingMode=!0,r.isPanning=!1},i("hand").onclick=function(){r.isDrawingMode=!1,r.isPanning=!0},i("new").onclick=()=>{r.remove(...r.getObjects().concat()),r.setZoom(1),r.requestrenderAll()},i("del").onclick=()=>{const e=r.getActiveObjects();e.forEach(e=>{r.remove(e)}),r.requestRenderAll()},window.onclick=e=>{const t=e.target.closest("a");var o;t&&t.hasAttribute("obj")&&(o=t.getAttribute("value"),e=t.getAttribute("obj"),a(t,e,o))},i("swi").onchange=e=>{a(e.target,"strokeWidth",e.target.value)},i("swo").onchange=e=>{a(e.target,"opacity",e.target.value)},r.on("object:modified",()=>{r.undo.push({undo:()=>r.remove(e.target),redo:()=>r.add(e.target)})}),r.on("object:added",e=>{r.undo.push({undo:()=>{e.target.vilaundo=!0,r.remove(e.target)},redo:()=>{r.add(e.target)}})}),r.on("object:removed",e=>{r.undo.push({undo:()=>r.add(e.target),redo:()=>r.remove(e.target)})}),r.freeDrawingBrush=new fabric.PencilBrush(r,{statefullCache:!0,decimate:16}),r.freeDrawingBrush&&((o=r.freeDrawingBrush).color=r.selectedStrokeColor,o.getPatternSrc&&(o.source=o.getPatternSrc.call(o)),o.width=2,o.shadow=new fabric.Shadow({blur:5,offsetX:3,offsetY:3,affectStroke:!0,color:"#00000022"}))}(),window.addEventListener("load",function(){var e=this.__canvas||this.canvas,t=this.__canvases||this.canvases;if(e&&e.calcOffset&&e.calcOffset(),t&&t.length)for(var o=0,n=t.length;o<n;o++)t[o].calcOffset()});