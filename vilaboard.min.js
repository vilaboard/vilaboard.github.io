(function(){void 0===String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")});const TOOL={FORMULA:0,TEXT:1,LINE:2,DRAW:3,SELECT:4,ERASE:5,MAX:6,PATH:7};var c=this.__c=new fabric.Canvas("c",{preserveObjectStacking:!0,selectedTool:TOOL.DRAW,fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0,currentObj:null,isDrawingMode:!0,isFullScreen:!1,selectedFill:"#"+up.get("f")||"#000000",selectedStrokeColor:"#"+up.get("f")||"#000000",selectedStroke:3,selectedFont:"sans-serif",selectedDash:null,undo:[],bg:null,clipboard:null,pointer:"crosshair",anim:{obj:[null,null,null,null,null,null,null,null,null,null],add:e=>{c.anim.obj.every(((t,o)=>null!=t||(e.index=o,c.anim.obj[o]=e,!1)))}},mouseDown:null,mouseUp:null,pan:1});c.TOOL=TOOL,c.toolChange=toolChange;var ctxm=$("ctxm"),txt=$("txt"),select=$("select"),draw=$("draw"),del=$("del"),line=$("line"),texf=$("texf"),panup=$("panup"),pandown=$("pandown"),debug=$("dbg");function setBack(e){fabric.Image.fromURL(e,(function(e){c.bg=e,c.bg&&c.setBackgroundImage(c.bg,c.renderAll.bind(c),{scaleX:c.width/c.bg.width,scaleY:c.height/c.bg.height,backgroundImageStretch:!0,imageSmoothing:!1,visible:!1})}))}function selection(e){0==c.selection&&c.discardActiveObject().renderAll();const t=e.selected[0];"strokeWidth"in t&&($("swi").value=t.strokeWidth),"opacity"in t&&($("swo").value=t.opacity)}function mousemove(e){if(null!=c.currentObj&&c.selectedTool==TOOL.LINE){var t=c.getPointer(e);c.currentObj.set({x2:t.x,y2:t.y}),c.renderAll()}}function TextBox(e,t=""){c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing&&c.currentObj.exitEditing();let o=new fabric.Textbox(t,{fill:c.selectedFill,fontFamily:c.selectedFont,top:e.y,left:e.x,width:c.width/3,isEditing:!0,shadow:null});o.setControlsVisibility({mt:!1,mb:!1,ml:!1}),c.currentObj=o,c.anim.add(o),c.add(o),c.setActiveObject(o),o.exitEditing(),o.enterEditing()}function toolChange(e){switch(e>=TOOL.MAX&&(e=0),c.selectedTool==TOOL.FORMULA&&e!=TOOL.FORMULA&&null!=c.currentObj&&c.anim.add(c.currentObj),c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing&&c.currentObj.exitEditing(),c.isDrawingMode=!1,c.selection=!1,c.currentObj=null,c.off("mouse:move"),document.toolbarForm.tool.value=e.toString(10),console.log(e.toString,document.toolbarForm.tool.value),e){case TOOL.TEXT:c.pointer="text";break;case TOOL.SELECT:c.selection=!0;break;case TOOL.DRAW:c.isDrawingMode=!0;break;case TOOL.ERASE:c.getActiveObjects().forEach((e=>{c.remove(e)})),c.discardActiveObject(),c.requestRenderAll();break;case TOOL.LINE:c.on("mouse:move",mousemove);case TOOL.LINE:case TOOL.PATH:case TOOL.FORMULA:}c.selectedTool=e}function setAtt(target,obj,value){if(null===obj)return;const active=c.getActiveObject();switch(obj){case"svg":fabric.loadSVGFromString(target.innerHTML,(e=>{svg=fabric.util.groupSVGElements(e),svg.top=window.pageYOffset+100,svg.left=c.width/2,svg.set({strokeUniform:!0}),c.add(svg.scale(5)),c.setActiveObject(svg),c.requestRenderAll(),toolChange(TOOL.SELECT)}));break;case"stroke":c.selectedStrokeColor=value,active&&active.set("stroke",c.selectedStrokeColor),c.freeDrawingBrush.color=c.selectedStrokeColor;break;case"sendback":active&&c.sendBackwards(active);break;case"sendup":active&&c.bringForward(active)}if(null!=value)switch(obj){case"opacity":active&&active.set("opacity",value),$("swo").value=value;break;case"color":c.selectedFill=value,active&&active.set("fill",c.selectedFill),c.freeDrawingBrush.color=c.selectedFill,c.selectedStrokeColor=value,active&&active.set("stroke",c.selectedStrokeColor);break;case"fill":c.selectedFill=value,active&&active.set("fill",c.selectedFill),c.freeDrawingBrush.color=c.selectedFill;break;case"stroke-dasharray":c.selectedDash=eval(value),console.log(value,c.selectedDash),c.selectedDash&&(c.selectedDash[0]*=1+c.selectedStroke,c.selectedDash[1]*=1+c.selectedStroke),console.log(value,c.selectedDash),active?active.set("stroke-dasharray",c.selectedDash):toolChange(TOOL.LINE);break;case"strokeWidth":let x=parseFloat(value,10);const y=28.44106*Math.exp(-1*Math.pow(x-16.32751,2)/38.3047035912);c.selectedStroke=Math.pow(x,1.0001),active&&active.set("strokeWidth",c.selectedStroke),c.freeDrawingBrush.width=c.selectedStroke+1,$("swi").value=value;break;case"fontFamily":c.selectedFont=value,active?active.set("fontFamily",c.selectedFont):toolChange(TOOL.TEXT)}c.renderAll()}function contextmenu(e,t){ctxm.classList.contains("show")?ctxm.classList.remove("show"):(e[0]+120>c.width||e[1]+120>c.height?(ctxm.style.top=e[1]-110+"px",ctxm.style.left=e[0]-110+"px"):(ctxm.style.top=e[1]+"px",ctxm.style.left=e[0]+"px"),ctxm.classList.add("show"),$("kn").innerHTML=t?t.index:"")}c.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight+10}),up.get("color")&&c.setBackgroundColor("#"+up.get("color")),up.get("back")&&($("bk").src="/imgs/"+up.get("back")),up.get("pattern")&&c.setBackgroundColor({source:"/imgs/"+up.get("pattern"),repeat:"repeat"},(function(){c.backgroundColor.source.style.maxWidth="100px",c.renderAll(),console.log(c.backgroundColor.source)})),up.get("back")&&setBack("/imgs/"+up.get("back")),toolChange(TOOL.DRAW),$("exp").onclick=function(){c.objectCaching=!1,up.get("back")&&(c.backgroundImage&&(c.backgroundImage.scaleX=c.width/c.backgroundImage.width,c.backgroundImage.scaleY=c.height/c.backgroundImage.height),c.bg.visible=1),this.href=c.toDataURL({format:"png",quality:.8,width:c.width,height:c.height}),this.download="vilaboard-"+(new Date).getTime()+".png",up.get("back")&&(c.bg.visible=0),c.renderAll()},document.addEventListener("keydown",(function(e){if(null!=c.currentObj)return;const t=c.getActiveObject(),o=e.key;if("Delete"===o){c.getActiveObjects().forEach((e=>{c.remove(e)})),c.discardActiveObject()}if(e.ctrlKey&&"g"===o){if(e.preventDefault(),!t)return;if("activeSelection"!==t.type)return;t.toGroup()}if(e.key>=0&&e.key<=9&&null!=c.anim.obj[e.key]&&"visible"in c.anim.obj[e.key]&&(1==c.anim.obj[e.key].visible?c.anim.obj[e.key].set("visible",!1):c.anim.obj[e.key].set("visible",!0)),e.ctrlKey&&"z"===o){e.preventDefault();const t=c.undo.pop();void 0!==t&&t()}e.ctrlKey&&"c"===o&&(e.preventDefault(),t.clone((function(e){c.clipboard=e}))),e.ctrlKey&&"x"===o&&(e.preventDefault(),t.clone((function(e){c.clipboard=e})),c.remove(t)),e.ctrlKey&&"v"===o&&(e.preventDefault(),null!==c.clipboard&&(c.clipboard.top+=10,c.clipboard.left+=10,c.clipboard.clone((function(e){c.add(e),c.setActiveObject(e),c.isDrawingMode=!1})))),c.renderAll()})),window.addEventListener("resize",(function(){c.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight+c.pan}),c.calcOffset(),c.requestRenderAll()})),pandown.onclick=()=>{c.pan+=1,window.scrollTo(0,c.pan*window.innerHeight/2),c.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight/2*(1+c.pan)}),c.calcOffset(),c.requestRenderAll()},window.addEventListener("scroll",(()=>{window.innerHeight+window.pageYOffset>=document.body.offsetHeight&&pandown.onclick()})),c.on("mouse:up",(function(e){c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing?c.currentObj.exitEditing():c.selectedTool==TOOL.TEXT&&TextBox(c.getPointer(e))})),c.on("selection:created",selection),c.on("selection:updated",selection),c.on("mouse:down",(function(e){c.selectedTool==TOOL.FORMULA&&toolChange(TOOL.SELECT);var t=c.getPointer(e);3==e.button&&contextmenu([t.x,t.y-window.pageYOffset],e.target);var o=[t.x,t.y,t.x,t.y];null==c.currentObj&&c.selectedTool==TOOL.LINE&&3!=e.button?(c.currentObj=new fabric.Line(o,{targetFindTolerance:!0,stroke:c.selectedStrokeColor,strokeWidth:c.selectedStroke+1,strokeDashArray:c.selectedDash,fill:"",originX:"center",originY:"center",hasControls:!1,strokeLineCap:"round",bl:!1,tl:!1,tr:!1,ml:!1,mb:!1,mt:!1,mtr:!1}),c.currentObj.set({strokeUniform:!0}),c.add(c.currentObj)):null!=c.currentObj&&c.selectedTool==TOOL.LINE&&(c.currentObj.setCoords(),c.currentObj=null)})),$("new").onclick=()=>{c.remove(...c.getObjects().concat()),c.undo=[],c.anim.obj=[null,null,null,null,null,null,null,null,null,null],toolChange(TOOL.DRAW),c.clipboard=null,c.currentObj=null,c.pan=1,pandown.onclick()},$("upl").onchange=e=>{if(e.target.files.length>0)for(let t=0;t<e.target.files.length;t++){let o=new FileReader;o.onload=e=>{url=e.target.result;new fabric.Image.fromURL(url,(e=>{e.top=window.pageYOffset+100,e.left=c.width/4;var t=1;t=e.height>e.width?c.height/(2*e.height):c.width/(2*e.width),e.scaleX=t,e.scaleY=t,c.anim.add(e),c.add(e),c.setActiveObject(e),toolChange(TOOL.SELECT)}))},o.readAsDataURL(e.target.files[t])}},$("upf").onchange=e=>{if(e.target.files.length>0){let t=new FileReader;t.onload=e=>{url=e.target.result,setBack(url)},t.readAsDataURL(e.target.files[0])}},$("slv").onclick=function(){json=c.toJSON(),obj=c.toObject(),this.href="data:text/plain;base64,"+btoa(JSON.stringify(json)),this.download="vilaboard-"+(new Date).getTime()+".vlb"},$("abr").onchange=e=>{if(e.target.files.length>0){let t=new FileReader;t.onload=e=>{json=JSON.parse(e.target.result),$("new").onclick(),c.loadFromJSON(json,(()=>{c.renderAll()}))},t.readAsText(e.target.files[0])}},$("txtfile").onchange=e=>{if(e.target.files.length>0){let t=new FileReader;t.onload=e=>{let o=t.result.toString(),n=(c.width,c.height,o.length);console.log(n);let l=new fabric.Textbox(o,{fill:c.selectedFill,fontFamily:c.selectedFont,fontSize:12+100/n,top:60+window.pageYOffset,left:10,width:120+n%c.width,isEditing:!1,shadow:null,padding:1});l.setControlsVisibility({mt:!1,mb:!1,ml:!1}),c.anim.add(l),c.add(l),toolChange(TOOL.SELECT),c.renderAll()},t.readAsText(e.target.files[0])}},txt.onclick=()=>{toolChange(TOOL.TEXT)},select.onclick=()=>{toolChange(TOOL.SELECT)},draw.onclick=()=>{toolChange(TOOL.DRAW)},del.onclick=()=>{toolChange(TOOL.ERASE)},line.onclick=()=>{toolChange(TOOL.LINE)},window.onmousedown=e=>{4==e.buttons&&toolChange(c.selectedTool+1)},window.onclick=e=>{const t=e.target.closest("a");if(t&&t.hasAttribute("obj")){const e=t.getAttribute("value"),c=t.getAttribute("obj");setAtt(t,c,e)}ctxm.classList.contains("show")&&ctxm.classList.remove("show")},$("swi").onchange=e=>{setAtt(e.target,"strokeWidth",e.target.value)},$("swo").onchange=e=>{setAtt(e.target,"opacity",e.target.value)},c.on("object:added",(e=>{e.target.on("mousedown",(function(e){c.getPointer(e);c.selectedTool==TOOL.ERASE&&c.remove(this)})),c.undo.push((()=>{"anim"in e.target&&(c.anim[e.target.anim]=null),c.off("object:removed"),c.remove(e.target),c.on("object:removed")}))})),c.on("object:removed",(e=>{c.undo.push((()=>{c.off("object:added"),c.add(e.target),c.on("object:added")}))})),MathJax._.input.tex_ts.TeX.prototype.formatError=e=>{throw Error("TeX error: "+e.message)};const latexToImg=function(e){try{var t=MathJax.tex2svg(`${e}`,{em:10,ex:5,display:!1})}catch(e){return}let o=t.getElementsByTagName("svg")[0].outerHTML.replace(/"currentColor"/g,`"${c.selectedFill}"`);fabric.loadSVGFromString(o,(e=>{var t=fabric.util.groupSVGElements(e);t.top=window.pageYOffset+100,t.left=c.width/3;var o=1;o=t.height>t.width?c.height/(3*t.height):c.width/(3*t.width),t.scale(o),null!=c.currentObj&&c.remove(c.currentObj),c.currentObj=t,c.add(t),c.setActiveObject(t)})),c.renderAll()};texf.oninput=e=>{c.selectedTool!=TOOL.FORMULA&&toolChange(TOOL.FORMULA),""!=e.target.value.trim()&&latexToImg(e.target.value)},texf.onkeyup=e=>{"Enter"===e.key?(null===c.currentObj&&""!=e.target.value&&latexToImg(e.target.value),c.setActiveObject(c.currentObj),toolChange(TOOL.SELECT),e.target.value=""):"Esc"===e.key&&(e.target.value="")},fabric.StyledBrush=fabric.util.createClass(fabric.PencilBrush,{type:"Styled",initialize:function(e,t){t||(t={}),this.callSuper("initialize",e,t)},_drawSegment:function(e,t,c){var o=t.x-c.x,n=t.y-c.y,l=Math.abs(Math.atan2(n,o)),r=1+5/(1+Math.sqrt(o*o+n*n))+1*l;r<0&&(r=2);var i=t.midPointFrom(c);return e.lineWidth=r,e.quadraticCurveTo(t.x,t.y,i.x,i.y),i}}),c.freeDrawingBrush=new fabric.PencilBrush(c),c.freeDrawingBrush.decimate=2,c.freeDrawingBrush.width=c.selectedStroke,c.freeDrawingBrush.color=c.selectedStrokeColor,fabric.Object.prototype.transparentCorners=!1,fabric.Object.prototype.borderColor="#cccccc77",fabric.Object.prototype.cornerColor="#cfcfffee",fabric.Object.prototype.cornerSize=7,fabric.Object.prototype.cornerStyle="circle"})(),window.addEventListener("load",(function(){var e=this.__c||this.c,t=this.__ces||this.ces;if(e&&e.calcOffset&&e.calcOffset(),t&&t.length)for(var c=0,o=t.length;c<o;c++)t[c].calcOffset()}));