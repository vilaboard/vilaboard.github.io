!function(){void 0===String.prototype.trim&&(String.prototype.trim=function(){return String(this).replace(/^\s+|\s+$/g,"")});var $=function(e){return document.getElementById(e)};const up=new URLSearchParams(window.location.search),TOOL={FORMULA:0,TEXT:1,LINE:2,DRAW:3,SELECT:4,PAN:5,ERASE:6,MAX:7,PATH:8};var panning=!1,c=this.__c=new fabric.Canvas("c",{preserveObjectStacking:!0,selectedTool:TOOL.DRAW,fireRightClick:!0,fireMiddleClick:!0,stopContextMenu:!0,currentObj:null,isDrawingMode:!0,isPanning:!1,isFullScreen:!1,selectedFill:"#"+up.get("f")||"#000000",selectedStrokeColor:"#"+up.get("f")||"#000000",selectedStroke:3,selectedFont:"sans-serif",selectedDash:null,undo:[],redo:[],bg:null,clipboard:null,backgroundVpt:!1,pointer:"crosshair",anim:{obj:[null,null,null,null,null,null,null,null,null,null],add:e=>{c.anim.obj.every((t,n)=>null!=t||(e.index=n,c.anim.obj[n]=e,!1))}},mouseDown:null,mouseUp:null,keyDown:null,grid:{padding:0,opacity:50,space:5}});c.TOOL=TOOL,c.toolChange=toolChange;var ctxm=$("ctxm");function setBack(e){fabric.Image.fromURL(e,function(e){c.bg=e,c.bg&&c.setBackgroundImage(c.bg,c.renderAll.bind(c),{scaleX:c.width/c.bg.width,scaleY:c.height/c.bg.height,backgroundImageStretch:!0})})}function selection(e){0==c.selection&&c.discardActiveObject().renderAll();const t=e.selected[0];"strokeWidth"in t&&($("swi").value=t.strokeWidth),"opacity"in t&&($("swo").value=t.opacity)}function TextBox(e){c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing&&c.currentObj.exitEditing();let t=new fabric.Textbox("",{fill:c.selectedFill,fontFamily:c.selectedFont,top:e.y,left:e.x,width:c.width/3,isEditing:!0,shadow:null});c.currentObj=t,c.anim.add(t),c.add(t),c.setActiveObject(t),t.exitEditing(),t.enterEditing()}function toolChange(e){if(e>=TOOL.MAX&&(e=0),c.isDrawingMode=!1,c.isPanning=!1,c.selection=!1,c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing&&c.currentObj.exitEditing(),c.currentObj=null,$("txt").classList.remove("active"),$("select").classList.remove("active"),$("draw").classList.remove("active"),$("del").classList.remove("active"),$("hand").classList.remove("active"),$("line").classList.remove("active"),$("texf").classList.remove("active"),e==TOOL.TEXT)$("txt").classList.add("active"),c.pointer="text";else if(e==TOOL.SELECT)$("select").classList.add("active"),c.selection=!0;else if(e==TOOL.DRAW)$("draw").classList.add("active"),c.isDrawingMode=!0;else if(e==TOOL.PAN)$("hand").classList.add("active"),c.isPanning=!0;else if(e==TOOL.ERASE){c.getActiveObjects().forEach(e=>{c.remove(e)}),c.discardActiveObject(),c.requestRenderAll(),$("del").classList.add("active")}else e==TOOL.LINE?$("line").classList.add("active"):e==TOOL.PATH||e==TOOL.FORMULA&&$("texf").classList.add("active");c.selectedTool=e}function setAtt(target,obj,value){const active=c.getActiveObject();if("svg"===obj&&fabric.loadSVGFromString(target.innerHTML,e=>{svg=fabric.util.groupSVGElements(e),svg.top=c.height/2,svg.left=c.width/2,c.add(svg.scale(5)),c.setActiveObject(svg),c.requestRenderAll(),toolChange(TOOL.SELECT)}),"stroke"===obj&&(c.selectedStrokeColor=value,active&&active.set("stroke",c.selectedStrokeColor),c.freeDrawingBrush.color=c.selectedStrokeColor),"sendback"==obj&&active&&c.sendBackwards(active),"sendup"==obj&&active&&c.bringForward(active),null!=obj&&null!=value){if("opacity"===obj&&(active&&active.set("opacity",value),$("swo").value=value),"color"===obj&&(c.selectedFill=value,active&&active.set("fill",c.selectedFill),c.freeDrawingBrush.color=c.selectedFill,c.selectedStrokeColor=value,active&&active.set("stroke",c.selectedStrokeColor)),"fill"===obj&&(c.selectedFill=value,active&&active.set("fill",c.selectedFill),c.freeDrawingBrush.color=c.selectedFill),"stroke-dasharray"===obj&&(c.selectedDash=eval(value),c.selectedDash[0]*=1+c.selectedStroke,c.selectedDash[1]*=1+c.selectedStroke,active?active.set("stroke-dasharray",c.selectedDash):toolChange(TOOL.LINE)),"strokeWidth"===obj){let e=parseFloat(value,10);const t=28.44106*Math.exp(-1*Math.pow(e-16.32751,2)/38.3047035912);c.selectedStroke=Math.pow(e,1.0001),active&&active.set("strokeWidth",c.selectedStroke),c.freeDrawingBrush.width=c.selectedStroke+1,$("swi").value=value}"fontFamily"===obj&&(c.selectedFont=value,active?active.set("fontFamily",c.selectedFont):toolChange(TOOL.TEXT))}c.renderAll()}function contextmenu(e,t){ctxm.classList.contains("show")?ctxm.classList.remove("show"):(e[0]+120>c.width||e[1]+120>c.height?(ctxm.style.top=e[1]-110+"px",ctxm.style.left=e[0]-110+"px"):(ctxm.style.top=e[1]+"px",ctxm.style.left=e[0]+"px"),ctxm.classList.add("show"),$("kn").innerHTML=t?t.index:"")}c.setZoom(1),c.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight}),c.setBackgroundColor("#ffffff"),up.get("pattern")&&c.setBackgroundColor({source:"/imgs/"+up.get("pattern"),repeat:"repeat"},function(){c.renderAll()}),up.get("back")&&setBack("/imgs/"+up.get("back")),toolChange(TOOL.DRAW),document.addEventListener("keyup",function(e){c.keyDown=!1}),document.addEventListener("keydown",function(e){if(c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing)return;const t=c.getActiveObject(),n=e.key;if(c.keyDown=e.key,"Delete"===n){c.getActiveObjects().forEach(e=>{c.remove(e)}),c.discardActiveObject()}if(e.ctrlKey&&"g"===n){if(e.preventDefault(),!t)return;if("activeSelection"!==t.type)return;t.toGroup()}if(e.key>=0&&e.key<=9&&null!=c.anim.obj[e.key]&&"visible"in c.anim.obj[e.key]&&(1==c.anim.obj[e.key].visible?c.anim.obj[e.key].set("visible",!1):c.anim.obj[e.key].set("visible",!0)),e.ctrlKey&&"z"===n){e.preventDefault();const t=c.undo.pop();void 0!==t&&t()}e.ctrlKey&&"c"===n&&(e.preventDefault(),t.clone(function(e){c.clipboard=e})),e.ctrlKey&&"x"===n&&(e.preventDefault(),t.clone(function(e){c.clipboard=e}),c.remove(t)),e.ctrlKey&&"v"===n&&(e.preventDefault(),null!==c.clipboard&&(c.clipboard.top+=10,c.clipboard.left+=10,c.clipboard.clone(function(e){c.add(e),c.setActiveObject(e),c.isDrawingMode=!1}))),c.renderAll()}),window.addEventListener("resize",function(){c.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight}),c.backgroundImage&&(c.backgroundImage.scaleX=c.width/c.backgroundImage.width,c.backgroundImage.scaleY=c.height/c.backgroundImage.height),c.requestRenderAll()}),$("teach").addEventListener("wheel",e=>{e.preventDefault();const t=c.getZoom();e.deltaY<0&&t<10&&c.setZoom(1.1*t),e.deltaY>0&&t>.3&&c.setZoom(.9*t),c.requestRenderAll()}),c.on("mouse:up",function(e){panning=!1,c.mouseDown=null}),c.on("selection:created",selection),c.on("selection:updated",selection),c.on("mouse:up",function(e){c.currentObj&&"isEditing"in c.currentObj&&c.currentObj.isEditing?c.currentObj.exitEditing():c.selectedTool==TOOL.TEXT&&TextBox(c.getPointer(e))}),c.on("mouse:down",function(e){c.selectedTool==TOOL.FORMULA&&4==e.buttons&&toolChange(TOOL.SELECT),panning=c.isPanning,c.mouseDown=e.pointer;var t=c.getPointer(e);3==e.button&&contextmenu([t.x,t.y],e.target);var n=[t.x,t.y,t.x,t.y];null==c.currentObj&&c.selectedTool==TOOL.LINE&&3!=e.button?(c.currentObj=new fabric.Line(n,{targetFindTolerance:!0,stroke:c.selectedStrokeColor,strokeWidth:c.selectedStroke+1,strokeDashArray:c.selectedDash,fill:"",originX:"center",originY:"center",hasControls:!1,strokeLineCap:"round",bl:!1,tl:!1,tr:!1,ml:!1,mb:!1,mt:!1,mtr:!1}),c.add(c.currentObj)):null!=c.currentObj&&c.selectedTool==TOOL.LINE&&(c.currentObj.setCoords(),c.currentObj=null),null==c.currentObj&&(c.selectedTool,TOOL.PATH)}),c.on("mouse:move",function(e){if(panning&&e&&e.e){c.selection=!1;const t=new fabric.Point(e.e.movementX,e.e.movementY);c.relativePan(t)}if(null!=c.currentObj&&c.selectedTool==TOOL.LINE){var t=c.getPointer(e);c.currentObj.set({x2:t.x,y2:t.y}),c.renderAll()}null!=c.currentObj&&(c.selectedTool,TOOL.PATH)}),fabric.Object.prototype.transparentCorners=!1,fabric.Object.prototype.borderColor="#cccccc77",fabric.Object.prototype.cornerColor="#cfcfffee",fabric.Object.prototype.cornerSize=7,fabric.Object.prototype.cornerStyle="circle",$("new").onclick=(()=>{c.remove(...c.getObjects().concat()),c.setZoom(1),c.requestRenderAll()}),$("upl").onchange=(e=>{if(e.target.files.length>0)for(let t=0;t<e.target.files.length;t++){let n=new FileReader;n.onload=(e=>{url=e.target.result;new fabric.Image.fromURL(url,e=>{e.top=c.height/4,e.left=c.width/4;var t=1;t=e.height>e.width?c.height/(2*e.height):c.width/(2*e.width),e.scaleX=t,e.scaleY=t,c.anim.add(e),c.add(e),c.setActiveObject(e),toolChange(TOOL.SELECT)})}),n.readAsDataURL(e.target.files[t])}}),$("upf").onchange=(e=>{if(e.target.files.length>0){let t=new FileReader;t.onload=(e=>{url=e.target.result,setBack(url)}),t.readAsDataURL(e.target.files[0])}}),$("exp").onclick=function(){this.href=c.toDataURL({format:"png",quality:.8,width:c.width,height:c.height}),this.download="vilaboard-"+(new Date).getTime()+".png"},$("txt").onclick=(()=>{toolChange(TOOL.TEXT)}),$("select").onclick=(()=>{toolChange(TOOL.SELECT)}),$("draw").onclick=(()=>{toolChange(TOOL.DRAW)}),$("hand").onclick=(()=>{toolChange(TOOL.PAN)}),$("del").onclick=(()=>{toolChange(TOOL.ERASE)}),$("line").onclick=(()=>{toolChange(TOOL.LINE)}),window.onmousedown=(e=>{4==e.buttons&&toolChange(c.selectedTool+1)}),window.onclick=(e=>{const t=e.target.closest("a");if(t&&t.hasAttribute("obj")){const e=t.getAttribute("value"),c=t.getAttribute("obj");setAtt(t,c,e)}ctxm.classList.contains("show")&&ctxm.classList.remove("show")}),$("swi").onchange=(e=>{setAtt(e.target,"strokeWidth",e.target.value)}),$("swo").onchange=(e=>{setAtt(e.target,"opacity",e.target.value)}),c.on("object:added",e=>{e.target.on("mousedown",function(e){c.getPointer(e);c.selectedTool==TOOL.ERASE&&c.remove(this)}),c.undo.push(()=>{"anim"in e.target&&(c.anim[e.target.anim]=null),c.off("object:removed"),c.remove(e.target),c.on("object:removed")})}),c.on("object:removed",e=>{c.undo.push(()=>{c.off("object:added"),c.add(e.target),c.on("object:added")})}),MathJax._.input.tex_ts.TeX.prototype.formatError=(e=>{throw Error("TeX error: "+e.message)});const latexToImg=function(e){try{var t=MathJax.tex2svg(`${e}`,{em:10,ex:5,display:!1})}catch(e){return}let n=t.getElementsByTagName("svg")[0].outerHTML.replace(/"currentColor"/g,`"${c.selectedFill}"`);fabric.loadSVGFromString(n,e=>{var t=fabric.util.groupSVGElements(e);t.top=c.height/3,t.left=c.width/3;var n=1;n=t.height>t.width?c.height/(3*t.height):c.width/(3*t.width),t.scale(n),null!=c.currentObj&&c.remove(c.currentObj),c.currentObj=t,c.anim.add(t),c.add(t),c.setActiveObject(t)}),c.renderAll()};$("texf").oninput=(e=>{c.selectedTool!=TOOL.FORMULA&&toolChange(TOOL.FORMULA),""!=e.target.value.trim()&&latexToImg(e.target.value)}),$("texf").onkeyup=(e=>{"Enter"===e.key&&(null===c.currentObj&&""!=e.target.value&&latexToImg(e.target.value),c.setActiveObject(c.currentObj),toolChange(TOOL.SELECT)),"Esc"===e.key&&(e.target.value="")}),c.freeDrawingBrush=new fabric.PencilBrush(c),c.freeDrawingBrush.decimate=4,c.freeDrawingBrush.width=c.selectedStroke,c.freeDrawingBrush.color=c.selectedStrokeColor}(),window.addEventListener("load",function(){var e=this.__c||this.c,t=this.__ces||this.ces;if(e&&e.calcOffset&&e.calcOffset(),t&&t.length)for(var c=0,n=t.length;c<n;c++)t[c].calcOffset()});