(function(){var $=function(id){return document.getElementById(id)};const up=new URLSearchParams(window.location.search);const TOOL={TEXT:0,PAN:1,SELECT:2,DRAW:3,ERASE:4,LINE:5,PATH:6,};var panning=!1;var canvas=this.__canvas=new fabric.Canvas('c',{selectedTool:TOOL.DRAW,currentObj:null,isDrawingMode:!0,isPanning:!1,isFullScreen:!1,selectedFill:("#"+up.get('f'))||"#000000",selectedStrokeColor:("#"+up.get('f'))||"#000000",selectedStroke:2,selectedFont:'sans-serif',undo:[],redo:[],bg:null,clipboard:null,backgroundVpt:!1,pointer:'crosshair',files:[],mouseDown:null,mouseUp:null,keyDown:null,grid:{padding:0,opacity:50,space:5,}});const triangle="M 0 0 L 0 100 l 100 0  z";canvas.setZoom(1.0);canvas.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight,});canvas.setBackgroundColor("#ffffff");if(up.get('pattern'))
canvas.setBackgroundColor({source:"/imgs/"+up.get('pattern'),repeat:'repeat'},function(){canvas.renderAll()});if(up.get('back'))setBack("/imgs/"+up.get('back'));toolChange(TOOL.DRAW);function setBack(url){fabric.Image.fromURL(url,function(img){canvas.bg=img;if(canvas.bg)
canvas.setBackgroundImage(canvas.bg,canvas.renderAll.bind(canvas),{scaleX:canvas.width/canvas.bg.width,scaleY:canvas.height/canvas.bg.height,backgroundImageStretch:!0,})})}
document.addEventListener('keyup',function(e){canvas.keyDown=!1})
document.addEventListener('keydown',function(e){const obj=canvas.getActiveObject();const key=e.key;canvas.keyDown=e.key;if(key==="Delete"){const list=canvas.getActiveObjects();list.forEach(element=>{canvas.remove(element)});canvas.discardActiveObject();canvas.requestRenderAll()}
if(e.ctrlKey&&key==='g'){e.preventDefault();if(!obj)return;if(obj.type!=='activeSelection')return;obj.toGroup()}
if(e.ctrlKey&&key==='z'){e.preventDefault();const pop=canvas.undo.pop();if(typeof pop!=='undefined'){pop.undo()}}
if(e.ctrlKey&&key==='c'){e.preventDefault();obj.clone(function(cloned){canvas.clipboard=cloned})}
if(e.ctrlKey&&key==='x'){e.preventDefault();obj.clone(function(cloned){canvas.clipboard=cloned});canvas.remove(obj)}
if(e.ctrlKey&&key==='v'){e.preventDefault();if(canvas.clipboard!==null){canvas.clipboard.top+=10;canvas.clipboard.left+=10;canvas.clipboard.clone(function(cloned){canvas.add(cloned);canvas.setActiveObject(cloned);canvas.requestRenderAll();canvas.isDrawingMode=!1})}}});window.addEventListener("resize",function(){canvas.setDimensions({left:0,top:0,width:window.innerWidth,height:window.innerHeight,});if(canvas.backgroundImage){canvas.backgroundImage.scaleX=canvas.width/canvas.backgroundImage.width;canvas.backgroundImage.scaleY=canvas.height/canvas.backgroundImage.height}
canvas.requestRenderAll()})
document.addEventListener('wheel',(e)=>{e.preventDefault();const zoom=canvas.getZoom();if(e.deltaY<0&&zoom<10)canvas.setZoom(zoom*1.1);if(e.deltaY>0&&zoom>0.30)canvas.setZoom(zoom*0.9);canvas.requestRenderAll()})
canvas.on('mouse:up',function(e){panning=!1;canvas.mouseDown=null});function selection(e){if(canvas.selection==!1)canvas.discardActiveObject().renderAll();const selected=e.selected[0];if('strokeWidth' in selected)$('swi').value=selected.strokeWidth;if('opacity' in selected)$('swo').value=selected.opacity}
canvas.on('selection:created',selection);canvas.on('selection:updated',selection);canvas.on('mouse:up',function(e){if(canvas.selectedTool==TOOL.TEXT)TextBox(canvas.getPointer(e))})
canvas.on('mouse:down',function(e){panning=canvas.isPanning;canvas.mouseDown=e.pointer;var pointer=canvas.getPointer(e);var points=[pointer.x,pointer.y,pointer.x,pointer.y];if(canvas.currentObj==null&&canvas.selectedTool==TOOL.LINE){canvas.currentObj=new fabric.Line(points,{stroke:canvas.selectedStrokeColor,strokeWidth:canvas.selectedStroke,fill:'',originX:'center',originY:'center',hasControls:!1,strokeLineCap:'round',bl:!1,tl:!1,tr:!1,ml:!1,mb:!1,mt:!1,mtr:!1});canvas.add(canvas.currentObj)}else if(canvas.currentObj!=null&&canvas.selectedTool==TOOL.LINE)canvas.currentObj=null;if(canvas.currentObj==null&&canvas.selectedTool==TOOL.PATH){}});canvas.on('mouse:move',function(e){if(panning&&e&&e.e){canvas.selection=!1;const delta=new fabric.Point(e.e.movementX,e.e.movementY);canvas.relativePan(delta)}
if(canvas.currentObj!=null&&canvas.selectedTool==TOOL.LINE){var pointer=canvas.getPointer(e);canvas.currentObj.set({x2:pointer.x,y2:pointer.y});canvas.renderAll()}
if(canvas.currentObj!=null&&canvas.selectedTool==TOOL.PATH){}});fabric.Object.prototype.transparentCorners=!1;fabric.Object.prototype.borderColor="#cccccc77";fabric.Object.prototype.cornerColor="#cfcfffee";fabric.Object.prototype.cornerSize=7;fabric.Object.prototype.cornerStyle="circle";$('new').onclick=()=>{canvas.remove(...canvas.getObjects().concat());canvas.setZoom(1);canvas.requestRenderAll()};$('upl').onchange=(e)=>{if(e.target.files.length>0){for(let i=0;i<e.target.files.length;i++){let reader=new FileReader();reader.onload=(e)=>{url=e.target.result;const img=new fabric.Image.fromURL(url,(imgl)=>{imgl.top=canvas.height/4;imgl.left=canvas.width/4;var r=1;if(imgl.height>imgl.width){r=canvas.height/(2*imgl.height)}else{r=canvas.width/(2*imgl.width)}
imgl.scaleX=r;imgl.scaleY=r;canvas.add(imgl);canvas.setActiveObject(imgl);toolChange(TOOL.SELECT)})}
reader.readAsDataURL(e.target.files[i])}}}
$('upf').onchange=(e)=>{if(e.target.files.length>0){let reader=new FileReader();reader.onload=(e)=>{url=e.target.result;setBack(url)}
reader.readAsDataURL(e.target.files[0])}}
function TextBox(points){if(canvas.currentObj&&'isEditing' in canvas.currentObj)if(canvas.currentObj.isEditing)canvas.currentObj.exitEditing();let text=new fabric.Textbox("",{fill:canvas.selectedFill,fontFamily:canvas.selectedFont,top:points.y,left:points.x,width:canvas.width/3,isEditing:!0,shadow:null,})
canvas.currentObj=text;canvas.add(text);canvas.setActiveObject(text);text.exitEditing();text.enterEditing()}
$('exp').onclick=function(){this.href=canvas.toDataURL({format:"png",quality:0.8,width:canvas.width,height:canvas.height,});this.download="vilaboard-"+new Date().getTime()+".png"};function toolChange(t){canvas.isDrawingMode=!1;canvas.isPanning=!1;canvas.selection=!1;if(canvas.currentObj&&'isEditing' in canvas.currentObj)if(canvas.currentObj.isEditing)canvas.currentObj.exitEditing();canvas.currentObj=null;$('txt').classList.remove('active');$('select').classList.remove('active');$('draw').classList.remove('active');$('del').classList.remove('active');$('hand').classList.remove('active');$('line').classList.remove('active');if(t==TOOL.TEXT){$('txt').classList.add('active');canvas.pointer='text'}else if(t==TOOL.SELECT){$('select').classList.add('active');canvas.selection=!0}else if(t==TOOL.DRAW){$('draw').classList.add('active');canvas.isDrawingMode=!0}else if(t==TOOL.PAN){$('hand').classList.add('active');canvas.isPanning=!0}else if(t==TOOL.ERASE){const list=canvas.getActiveObjects();list.forEach(element=>{canvas.remove(element)});canvas.discardActiveObject();canvas.requestRenderAll();$('del').classList.add('active')}else if(t==TOOL.LINE){$('line').classList.add('active')}else if(t==TOOL.PATH){}
canvas.selectedTool=t}
$('txt').onclick=()=>{toolChange(TOOL.TEXT)};$('select').onclick=()=>{toolChange(TOOL.SELECT)};$('draw').onclick=()=>{toolChange(TOOL.DRAW)};$('hand').onclick=()=>{toolChange(TOOL.PAN)};$('del').onclick=()=>{toolChange(TOOL.ERASE)};$('line').onclick=()=>{toolChange(TOOL.LINE)}
function setAtt(target,obj,value){const active=canvas.getActiveObject();if(obj==='svg'){fabric.loadSVGFromString(target.innerHTML,(ob)=>{svg=fabric.util.groupSVGElements(ob)
svg.top=canvas.height/2;svg.left=canvas.width/2;canvas.add(svg.scale(5));canvas.setActiveObject(svg);canvas.requestRenderAll();toolChange(TOOL.SELECT)})}
console.log(target,obj,value);if(obj!=null&&value!=null){if(obj==='opacity'){if(active)active.set('opacity',value);$('swo').value=value}
if(obj==='fill'){canvas.selectedFill=value;if(active)active.set('fill',canvas.selectedFill);canvas.freeDrawingBrush.color=canvas.selectedFill}
if(obj==='stroke'){canvas.selectedStrokeColor=value;if(active)active.set('stroke',canvas.selectedStrokeColor);canvas.freeDrawingBrush.color=canvas.selectedStrokeColor}
if(obj==='strokeWidth'){let x=parseFloat(value,10);const y=28.44106*Math.exp(-1*Math.pow(x-16.32751,2)/(38.3047035912))
canvas.selectedStroke=Math.pow(x,1.0001);if(active)active.set('strokeWidth',canvas.selectedStroke);canvas.freeDrawingBrush.width=(canvas.selectedStroke+1);$('swi').value=value}
if(obj==='fontFamily'){canvas.selectedFont=value;if(active){active.set('fontFamily',canvas.selectedFont)}else{toolChange(TOOL.TEXT)}}
canvas.renderAll()}}
window.onclick=(e)=>{const target=e.target.closest('a');if(target&&target.hasAttribute('obj')){const value=target.getAttribute('value');const obj=target.getAttribute('obj');setAtt(target,obj,value)}}
$('swi').onchange=(e)=>{setAtt(e.target,'strokeWidth',e.target.value)}
$('swo').onchange=(e)=>{setAtt(e.target,'opacity',e.target.value)}
canvas.on('object:modified',()=>{canvas.undo.push({'undo':()=>canvas.remove(e.target),'redo':()=>canvas.add(e.target)})})
canvas.on('object:added',(e)=>{e.target.on('mousedown',function(e){if(canvas.selectedTool==TOOL.ERASE)canvas.remove(this)})
canvas.undo.push({'undo':()=>{e.target.vilaundo=!0;canvas.remove(e.target)},'redo':()=>{canvas.add(e.target)},})})
canvas.on('object:removed',(e)=>{canvas.undo.push({'undo':()=>canvas.add(e.target),'redo':()=>canvas.remove(e.target)})})
canvas.freeDrawingBrush=new fabric.PencilBrush(canvas);canvas.freeDrawingBrush.decimate=4;if(canvas.freeDrawingBrush){var brush=canvas.freeDrawingBrush;brush.color=canvas.selectedStrokeColor;if(brush.getPatternSrc){brush.source=brush.getPatternSrc.call(brush)}
brush.width=2;brush.shadow=new fabric.Shadow({blur:5,offsetX:3,offsetY:3,affectStroke:!0,color:"#00000022",})}})();(function(){window.addEventListener('load',function(){var canvas=this.__canvas||this.canvas,canvases=this.__canvases||this.canvases;canvas&&canvas.calcOffset&&canvas.calcOffset();if(canvases&&canvases.length){for(var i=0,len=canvases.length;i<len;i++){canvases[i].calcOffset()}}})})()